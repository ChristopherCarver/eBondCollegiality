<?xml version="1.0" encoding="UTF-8"?><unload unload_date="2021-09-21 21:35:13">
<sys_remote_update_set action="INSERT_OR_UPDATE">
<application display_value="Global">global</application>
<application_name>Global</application_name>
<application_scope>global</application_scope>
<application_version/>
<collisions/>
<commit_date/>
<deleted/>
<description/>
<inserted/>
<name>eBond - Templates</name>
<origin_sys_id/>
<parent display_value=""/>
<release_date/>
<remote_base_update_set display_value=""/>
<remote_parent_id/>
<remote_sys_id>39c417a8db7630107cb384d868961979</remote_sys_id>
<state>loaded</state>
<summary/>
<sys_class_name>sys_remote_update_set</sys_class_name>
<sys_created_by>admin</sys_created_by>
<sys_created_on>2021-09-21 21:35:12</sys_created_on>
<sys_id>e94a1bacdb7630107cb384d868961965</sys_id>
<sys_mod_count>0</sys_mod_count>
<sys_updated_by>admin</sys_updated_by>
<sys_updated_on>2021-09-21 21:35:12</sys_updated_on>
<update_set display_value=""/>
<update_source display_value=""/>
<updated/>
</sys_remote_update_set>
<sys_update_xml action="INSERT_OR_UPDATE">
<action>INSERT_OR_UPDATE</action>
<application display_value="Global">global</application>
<category>customer</category>
<comments/>
<name>sysevent_script_action_b0c917acdb7630107cb384d86896193a</name>
<payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update sys_domain="global" table="sysevent_script_action"&gt;&lt;sysevent_script_action action="INSERT_OR_UPDATE"&gt;&lt;active&gt;false&lt;/active&gt;&lt;condition_script/&gt;&lt;description/&gt;&lt;event_name&gt;ebond.relationship.management.{SUPPLIER}&lt;/event_name&gt;&lt;name&gt;eBond Relationship Management SUPPLIER&lt;/name&gt;&lt;order&gt;100&lt;/order&gt;&lt;script&gt;&lt;![CDATA[// build out the data payload for SUPPLIER 
// store it in u_ebond_rest_payloads to be sent to the SUPPLIER
var operation = event.parm1;
var dataBundle = event.parm2;
var returnStatus = new eBondIncident_SUPPLIER().preparePayload(operation, dataBundle);]]&gt;&lt;/script&gt;&lt;synchronous&gt;false&lt;/synchronous&gt;&lt;sys_class_name&gt;sysevent_script_action&lt;/sys_class_name&gt;&lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2021-09-21 21:34:15&lt;/sys_created_on&gt;&lt;sys_domain&gt;global&lt;/sys_domain&gt;&lt;sys_domain_path&gt;/&lt;/sys_domain_path&gt;&lt;sys_id&gt;b0c917acdb7630107cb384d86896193a&lt;/sys_id&gt;&lt;sys_mod_count&gt;0&lt;/sys_mod_count&gt;&lt;sys_name&gt;eBond Relationship Management SUPPLIER&lt;/sys_name&gt;&lt;sys_overrides/&gt;&lt;sys_package display_value="Global" source="global"&gt;global&lt;/sys_package&gt;&lt;sys_policy/&gt;&lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;&lt;sys_update_name&gt;sysevent_script_action_b0c917acdb7630107cb384d86896193a&lt;/sys_update_name&gt;&lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2021-09-21 21:34:15&lt;/sys_updated_on&gt;&lt;/sysevent_script_action&gt;&lt;/record_update&gt;</payload>
<payload_hash>1880787244</payload_hash>
<remote_update_set display_value="eBond - Templates">e94a1bacdb7630107cb384d868961965</remote_update_set>
<replace_on_upgrade>false</replace_on_upgrade>
<sys_created_by>admin</sys_created_by>
<sys_created_on>2021-09-21 21:35:12</sys_created_on>
<sys_id>294a1bacdb7630107cb384d868961966</sys_id>
<sys_mod_count>0</sys_mod_count>
<sys_recorded_at>17c0a47e1d60000001</sys_recorded_at>
<sys_updated_by>admin</sys_updated_by>
<sys_updated_on>2021-09-21 21:35:12</sys_updated_on>
<table>ebond.relationship.management.{SUPPLIER}</table>
<target_name>eBond Relationship Management SUPPLIER</target_name>
<type>Script Action</type>
<update_domain>global</update_domain>
<update_guid>ab0a1bacb4763010ec3e8a524ca39f62</update_guid>
<update_guid_history>ab0a1bacb4763010ec3e8a524ca39f62:1880787244</update_guid_history>
<update_set display_value=""/>
<view/>
</sys_update_xml>
<sys_update_xml action="INSERT_OR_UPDATE">
<action>INSERT_OR_UPDATE</action>
<application display_value="Global">global</application>
<category>customer</category>
<comments/>
<name>sys_script_include_6d961fe8db7630107cb384d86896190d</name>
<payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;&lt;sys_script_include action="INSERT_OR_UPDATE"&gt;&lt;access&gt;package_private&lt;/access&gt;&lt;active&gt;true&lt;/active&gt;&lt;api_name&gt;global.eBondIncident_SUPPLIER&lt;/api_name&gt;&lt;caller_access/&gt;&lt;client_callable&gt;false&lt;/client_callable&gt;&lt;description/&gt;&lt;name&gt;eBondIncident_SUPPLIER&lt;/name&gt;&lt;script&gt;&lt;![CDATA[var eBondIncident_SUPPLIER = Class.create();
eBondIncident_SUPPLIER.prototype = {
    // func: initialize
    // desc: initializes the JavaScript object
    // parm: n/a
    // retn: true or false
    initialize: function() {
        // static 
        this.eLog = new eBondLog();
        this.eLog.u_direction = 'outbound';
        this.eLog.u_location = 'Script Includes';
        this.eLog.u_name = 'eBondIncident_SUPPLIER';
        this.eLog.u_source = 'initialize';
        this.eLog.u_supplier = 'SUPPLIER';
        this.eLog.u_correlate_id = current.sys_id;
        this.eLog.u_correlate_class_name = current.sys_class_name;
        this.eLog.write('Debug', 'Entering.');

        this.supplier = 'SUPPLIER';
        this.restMsg = 'SUPPLIER'; // declaration in ServiceNow REST message
        this.httpMethod = 'Incident'; // declaration in ServiceNow REST message

        // dynamic
        var company = new GlideRecord('core_company');
        company.addQuery('stock_symbol', this.supplier);
        company.query();
        if (company.next()) {
            this.company = company.sys_id;
        } else {
            this.eLog.write('High', 'Cannot find the supplier\'s (' + supplier + ') company record.');
        }

        var url = new GlideRecord('u_ebond_registry');
        url.addQuery('u_supplier', this.supplier);
        url.addQuery('u_key', 'outbound.url.endpoint');
        url.query();
        if (url.next()) {
            this.url = url.u_value;
        } else {
            this.eLog.write('High', supplier + ' is missing eBond registry key outbound.url.endpoint.');
        }

        this.eLog.write('Debug', 'Exiting.');
    },

    // func: checkCondition
    // desc: determines if the response is from SUPPLIER; called by ecc queue business rule
    // parm: n/a
    // retn: true or false
    checkCondition: function() {
        this.eLog.u_source = 'checkCondition';
        this.eLog.u_direction = 'inbound';
        this.eLog.write('Debug', 'Entering.');

        if (current.getValue('topic') == 'eBond_' + this.supplier + '_Response' &amp;&amp;
            (current.getValue('state') == 'ready' ||
                current.getValue('state') == 'error') &amp;&amp;
            current.getValue('name') == 'post' &amp;&amp;
            current.getValue('queue') == 'input') {
            this.eLog.write('Debug', 'Exiting. Return: true');
            return true;
        }

        this.eLog.write('Debug', 'Exiting. Return: false');
        return false;
    },

    /* 
       func: checkEcho
       desc: checks to see if the incident was updated by the supplier
       parm: n/a
       retn: true - the incident was updated by SUPPLIER
             false - the incident was not updated by SUPPLIER

    */
    checkEcho: function() {
        this.eLog.u_source = 'checkEcho';
        this.eLog.u_direction = 'outbound';
        this.eLog.write('Debug', 'Entering.');

        var echo = false;

        var registry = new GlideRecord('u_ebond_registry');
        registry.addQuery('u_supplier', this.supplier);
        registry.addQuery('u_key', 'inbound.account');
        registry.query();
        if (registry.next()) {
            if (registry.u_value == current.sys_updated_by) {
                echo = true;
            }
        }

        this.eLog.write('Debug', 'Exiting. Return: ' + echo);
        return echo;
    },

    // func: determineOperation
    // desc: updates to incident record does not mean updates to the supplier
    //       the existing incident could have been updated with new assignment group or eBonded with value
    // parm: n/a
    // retn: create or update
    determineOperation: function() {
        this.eLog.u_source = 'determineOperation';
        this.eLog.u_direction = 'outbound';
        this.eLog.write('Debug', 'Entering.');

        var decision = 'create';

        // check if the incident u_ebonded_with AND the assignment group is still associated with the supplier
        var arrUtil = new ArrayUtil();
        var arr = current.u_ebonded_with.toString().split(',');
        var pos = arrUtil.indexOf(arr, this.company);
        if (pos &lt; 0 &amp;&amp; current.assignment_group.u_company != this.company) {
            decision = 'delete';
            this.eLog.write('Debug', 'Exiting. Return: ' + decision);
            return decision;
        }

        // find existing relationship records
        var relationship = new GlideRecord('u_ebond_relationship');
        relationship.addQuery('u_source', current.sys_id);
        relationship.addQuery('u_status', 'ebonded');
        relationship.addQuery('u_company', this.company);
        relationship.query();
        if (relationship.next()) {
            decision = 'update';
        }

        this.eLog.write('Debug', 'Exiting. Return: ' + decision);
        return decision;
    },

    // func: insertOperation
    // desc: ServiceNow has inserted a new record
    // parm: dataBundle
    // retn: n/a
    insertOperation: function(dataBundle) {
        this.eLog.u_source = 'insertOperation';
        this.eLog.u_direction = 'outbound';
        this.eLog.write('Debug', 'Entering.');

        var parser = new JSONParser();
        var incidentData = parser.parse(dataBundle);

        var dataMap = new eBondDataMap();

        var data = {};
        data.ExternalNumber = current.number.toString();
        data.ExternalRef = current.sys_id.toString();

        for (var key in incidentData) {
            var map = dataMap.getSupplierValue(this.supplier, 'outbound', 'incident', key, incidentData[key], incidentData[key]);
            switch (key) {
                case "comment":
                    data.Comment = map.value;
                    break;
                case "work_note":
                    data.WorkNote = map.value;
                    break;
                case "description":
                    data.Desc = map.value;
                    break;
                case "short_description":
                    data.ShortDesc = map.value;
                    break;
                case "state":
                    data.State = map.value;
                    break;
                case "impact":
                    data.Impact = map.value;
                    break;
                case "urgency":
                    data.Urgency = map.value;
                    break;
                case "caller":
                    var caller = new GlideRecord('sys_user');
                    caller.addQuery('sys_id', map.value);
                    caller.query();
                    if (caller.next()) {
                        data.Caller = caller.getDisplayValue('email');
                    }
                    break;
                case "assignment_group":
                    var group = new GlideRecord('sys_user_group');
                    group.addQuery('sys_id', map.value);
                    group.query();
                    if (group.next()) {
                        data.AssignmentGroup = group.getDisplayValue('name');
                    }
                    break;
                case "ci":
                    var ci = new GlideRecord('cmdb_ci');
                    ci.addQuery('sys_id', 'map.value');
                    ci.query();
                    if (ci.next()) {
                        data.CI = ci.getDisplayValue('name');
                    }
                    break;
                case "contact_type":
                    data.Contact = map.value;
                    break;
                case "close_notes":
                    data.CloseNotes = map.value;
                    break;
                case "close_code":
                    data.CloseCode = map.value;
                    break;
                case "business_service":
                    var service = new GlideRecord('cmdb_ci_service');
                    service.addQuery('sys_id', map.value);
                    service.query();
                    if (service.next()) {
                        data.Service = service.getDisplayValue('name');
                    }
                    break;
                case "service_offering":
                    var service_offering = new GlideRecord('cmdb_ci_service');
                    service_offering.addQuery('sys_id', map.value);
                    service_offering.query();
                    if (service_offering.next()) {
                        data.ServiceOffering = service_offering.getDisplayValue('name');
                    }
                    break;
                case "category":
                    data.Category = map.value;
                    break;
                case "subcategory":
                    data.Subcategory = map.value;
                    break;
                default:
                    break;
            }
        }

        data.CommentHistory = current.comments.getJournalEntry(-1); // full comment history
        data.WorkNoteHistory = current.work_notes.getJournalEntry(-1); // full work note history

        var payload = JSON.stringify(data);
        this.eLog.write('Debug', 'Payload: \n' + payload);

        // create relationship record 
        var relationship = new GlideRecord('u_ebond_relationship');
        relationship.initialize();
        relationship.u_source_table = 'incident';
        relationship.u_source = current.sys_id;
        relationship.u_status = 'ebonded';
        relationship.u_state = current.state;
        relationship.u_out = 'wait';
        relationship.u_company = this.company;
        relationship.insert();

        // load REST payload into the pool to be processed
        var eBondRest = new eBondRestPayload().load(this.company, 'u_ebond_relationship', relationship.sys_id, '', this.url, payload, 'json', this.restMsg, this.httpMethod);

        this.eLog.write('Debug', 'Exiting.');
    },

    // func: createOperation
    // desc: ServiceNow has updated an existing record, but this is a new record for the supplier
    // parm: dataBundle
    // retn: n/a
    createOperation: function() {
        this.eLog.u_source = 'createOperation';
        this.eLog.u_direction = 'outbound';
        this.eLog.write('Debug', 'Entering.');

        var dataMap = new eBondDataMap();

        var data = {};
        data.ExternalNumber = current.number.toString();
        data.ExternalRef = current.sys_id.toString();

        data.Comment = current.comments.getJournalEntry(1);
        data.WorkNote = current.work_notes.getJournalEntry(1);
        data.Desc = current.getValue('description');
        data.ShortDesc = current.getValue('short_description');
        data.State = dataMap.getSupplierValue(this.supplier, 'outbound', 'incident', 'state', current.getValue('state'), '100').value;
        data.Impact = dataMap.getSupplierValue(this.supplier, 'outbound', 'incident', 'impact', current.getValue('impact'), '300').value;
        data.Urgency = dataMap.getSupplierValue(this.supplier, 'outbound', 'incident', 'urgency', current.getValue('urgency'), '300').value;
        data.Caller = current.caller.getDisplayValue('email');
        data.AssignmentGroup = current.getDisplayValue('assignment_group');
        data.CI = current.getDisplayValue('cmdb_ci');
        data.Contact = dataMap.getSupplierValue(this.supplier, 'outbound', 'incident', 'contact_type', current.getValue('contact_type'), 'digital').value;
        data.CloseNotes = current.getValue('close_notes');
        data.CloseCode = dataMap.getSupplierValue(this.supplier, 'outbound', 'incident', 'close_code', current.getValue('close_code'), '').value;
        data.Service = current.getDisplayValue('business_service');
        data.ServiceOffering = current.getDisplayValue('service_offering');
        data.Category = current.getDisplayValue('category');
        data.Subcategory = current.getDisplayValue('subcategory');
        data.Comment = current.comments.getJournalEntry(-1); // full comment history
        data.WorkNote = current.work_notes.getJournalEntry(-1); // full work note history
        var payload = JSON.stringify(data);
        this.eLog.write('Debug', 'Payload: \n' + payload);

        // create relationship record 
        var relationship = new GlideRecord('u_ebond_relationship');
        relationship.initialize();
        relationship.u_source_table = 'incident';
        relationship.u_source = current.sys_id;
        relationship.u_status = 'eBonded';
        relationship.u_state = current.state;
        relationship.u_out = 'wait';
        relationship.u_company = this.company;
        relationship.insert();

        // load REST payload into the pool to be processed
        var eBondRest = new eBondRestPayload().load(this.company, 'u_ebond_relationship', relationship.sys_id, '', this.url, payload, 'json', this.restMsg, this.httpMethod);

        this.eLog.write('Debug', 'Exiting.');
    },

    // func: updateOperation
    // desc: ServiceNow has updated the record, update the SUPPLIER records as appropriate
    // parm: dataBundle
    // retn: n/a
    updateOperation: function(dataBundle) {
        this.eLog.u_source = 'updateOperation';
        this.eLog.u_direction = 'outbound';
        this.eLog.write('Debug', 'Entering.');

        var parser = new JSONParser();
        var incidentData = parser.parse(dataBundle);

        var dataMap = new eBondDataMap();

        // traverse all related eBonds
        var relationship = new GlideRecord('u_ebond_relationship');
        relationship.addQuery('u_source', current.sys_id);
        relationship.addQuery('u_status', 'ebonded');
        relationship.addQuery('u_company', this.company);
        relationship.query();
        while (relationship.next()) {

            var data = {};
            data.number = relationship.u_correlation_number.toString();

            // if reflect, then perform data mapping
            if (relationship.u_reflect == true) {
                for (var key in incidentData) {
                    var map = dataMap.getSupplierValue(this.supplier, 'outbound', 'incident', key, incidentData[key], incidentData[key]);
                    switch (key) {
                        case "comment":
                            data.Comment = map.value;
                            break;
                        case "work_note":
                            data.WorkNote = map.value;
                            break;
                        case "description":
                            data.Desc = map.value;
                            break;
                        case "short_description":
                            data.ShortDesc = map.value;
                            break;
                        case "state":
                            data.State = map.value;
                            break;
                        case "impact":
                            data.Impact = map.value;
                            break;
                        case "urgency":
                            data.Urgency = map.value;
                            break;
                        case "caller":
                            var caller = new GlideRecord('sys_user');
                            caller.addQuery('sys_id', map.value);
                            caller.query();
                            if (caller.next()) {
                                data.Caller = caller.getDisplayValue('email');
                            }
                            break;
                        case "assignment_group":
                            var group = new GlideRecord('sys_user_group');
                            group.addQuery('sys_id', map.value);
                            group.query();
                            if (group.next()) {
                                data.AssignmentGroup = group.getDisplayValue('name');
                            }
                            break;
                        case "ci":
                            var ci = new GlideRecord('cmdb_ci');
                            ci.addQuery('sys_id', map.value);
                            ci.query();
                            if (ci.next()) {
                                data.CI = ci.getDisplayValue('name');
                            }
                            break;
                        case "contact_type":
                            data.Contact = map.value;
                            break;
                        case "close_notes":
                            data.CloseNotes = map.value;
                            break;
                        case "close_code":
                            data.CloseCode = map.value;
                            break;
                        case "business_service":
                            var service = new GlideRecord('cmdb_ci_service');
                            service.addQuery('sys_id', map.value);
                            service.query();
                            if (service.next()) {
                                data.Service = service.getDisplayValue('name');
                            }
                            break;
                        case "service_offering":
                            var service_offering = new GlideRecord('cmdb_ci_service');
                            service_offering.addQuery('sys_id', map.value);
                            service_offering.query();
                            if (service_offering.next()) {
                                data.ServiceOffering = service_offering.getDisplayValue('name');
                            }
                            break;
                        case "category":
                            data.Category = map.value;
                            break;
                        case "subcategory":
                            data.Subcategory = map.value;
                            break;
                        default:
                            break;
                    }
                }
            } else { // else, represent the changes as a comment
                var comment = '';
                var newline = '';
                for (var key in incidentData) {
                    switch (key) {
                        case 'caller':
                            var caller = new GlideRecord('sys_user');
                            caller.addQuery('sys_id', incidentData[key]);
                            caller.query();
                            if (caller.next()) {
                                comment += newline + key + ': ' + caller.getDisplayValue('email');
                            }
                            break;
                        case 'assignment_group':
                            var group = new GlideRecord('sys_user_group');
                            group.addQuery('sys_id', incidentData[key]);
                            group.query();
                            if (group.next()) {
                                comment += newline + key + ': ' + group.getDisplayValue('name');
                            }
                            break;
                        case 'ci':
                            var ci = new GlideRecord('cmdb_ci');
                            ci.addQuery('sys_id', incidentData[key]);
                            ci.query();
                            if (ci.next()) {
                                comment += newline + key + ': ' + ci.getDisplayValue('name');
                            }
                            break;
                        case 'business_service':
                            var service = new GlideRecord('cmdb_ci_service');
                            service.addQuery('sys_id', incidentData[key]);
                            service.query();
                            if (service.next()) {
                                comment += newline + key + ': ' + service.getDisplayValue('name');
                            }
                            break;
                        case 'service_offering':
                            var service_offering = new GlideRecord('cmdb_ci_service');
                            service_offering.addQuery('sys_id', incidentData[key]);
                            service_offering.query();
                            if (service_offering.next()) {
                                comment += newline + key + ': ' + service_offering.getDisplayValue('name');
                            }
                            break;
                        default:
                            var map = dataMap.getSupplierValue(this.supplier, 'outbound', 'incident', key, incidentData[key], incidentData[key]);
                            comment += newline + key + ': ' + map.value;
                            if (map.note != undefined &amp;&amp; map.note != '') {
                                comment += ' (' + map.note + ')';
                            }
                    }
                    newline = '\n';
                }
                data.comment = comment;
            }

            var payload = JSON.stringify(data);
            this.eLog.write('Debug', 'Payload: \n' + payload);

            // update the relationship record if in good standing
            if (relationship.getValue('u_out') == 'up') {
                relationship.u_out = 'wait';
                relationship.update();
            }

            // load REST payload into the pool to be processed
            var eBondRest = new eBondRestPayload().load(this.company, 'u_ebond_relationship', relationship.sys_id, '', this.url, payload, 'json', this.restMsg, this.httpMethod);
        }

        this.eLog.write('Debug', 'Exiting.');
    },

    // func: deleteOperation
    // desc: ServiceNow has deleted the record, debond associated SUPPLIER records
    //       update SUPPLIER to debond from the record
    //       deleted the ServiceNow relationship record
    // parm: n/a
    // retn: n/a
    deleteOperation: function() {
        this.eLog.u_source = 'deleteOperation';
        this.eLog.u_direction = 'outbound';
        this.eLog.write('Debug', 'Entering.');

        // traverse all related eBonds
        var relationship = new GlideRecord('u_ebond_relationship');
        relationship.addQuery('u_source', current.sys_id);
        relationship.addQuery('u_ebonded', 'true');
        relationship.addQuery('u_company', this.company);
        relationship.query();
        while (relationship.next()) {
            // prepare debond payload
            var data = {};
            data.number = relationship.u_correlation_number.toString();
            data.state = '0';
            var payload = JSON.stringify(data);

            var eBondRest = new eBondRestPayload().load(this.company, 'u_ebond_relationship', relationship.sys_id, '', this.url, payload, 'json', this.restMsg, this.httpMethod);

            // change the relationship
            relationship.u_status = 'debonded';
            relationship.update();
        }

        this.eLog.write('Debug', 'Exiting.');
    },

    // func: preparePayload
    // desc: prepares the incident payloads for SUPPLIER 
    // parm: operation - insert, update, or delete
    //       dataBundle - JSON representating the incident
    // retn: n/a
    preparePayload: function(operation, dataBundle) {
        this.eLog.u_source = 'preparePayload';
        this.eLog.u_direction = 'outbound';
        this.eLog.write('Debug', 'Entering.');
        this.eLog.write('Debug', 'operation = ' + operation);
        this.eLog.write('Debug', 'dataBundle = ' + dataBundle);

        if (this.checkEcho() == true) {
            this.eLog.u_source = 'preparePayload';
            this.eLog.write('Debug', 'Exiting.');
            return;
        }

        if (this.company == undefined) {
            this.eLog.write('Low', 'Company is not set, cannot continue.');
            this.eLog.write('Debug', 'Exiting.');
            return;
        }

        if (this.url == undefined) {
            this.eLog.write('Low', 'URL is not set, cannot continue.');
            this.eLog.write('Debug', 'Exiting.');
            return;
        }

        if (operation == 'insert') { // new incident record
            this.insertOperation(dataBundle);
            this.eLog.u_source = 'preparePayload';
        } else if (operation == 'update') { // updated incident record
            var decision = this.determineOperation(dataBundle);
            if (decision == 'create') { // decision is to create new record
                this.createOperation(dataBundle);
                this.eLog.u_source = 'preparePayload';
            } else if (decision == 'update') { // decision is to update existing record
                this.updateOperation(dataBundle); // decision is to update record(s)
                this.eLog.u_source = 'preparePayload';
            } else { // decision is to debond
                this.deleteOperation();
                this.eLog.u_source = 'preparePayload';
            }
        } else if (operation == 'delete') { // deleted incident record
            this.deleteOperation();
            this.eLog.u_source = 'preparePayload';
        }

        this.eLog.write('Debug', 'Exiting.');
        return;
    },

    // func: updateRelationship
    // desc: prepares the incident payloads for SUPPLIER on a change of relationship 
    // parm: operation - update
    //       dataBundle - JSON representating the status of the relationship
    // retn: n/a
    updateRelationship: function(operation, dataBundle) {
        this.eLog.u_source = 'updateRelationship';
        this.eLog.u_direction = 'outbound';
        this.eLog.write('Debug', 'Entering.');
        this.eLog.write('Debug', 'operation = ' + operation);
        this.eLog.write('Debug', 'dataBundle = ' + dataBundle);

        var parser = new JSONParser();
        var relationship = parser.parse(dataBundle);

        if (relationship.status == 'debonded') {
            var data = {};
            data.number = current.u_correlation_number.toString();
            data.state = '0'; // SUPPLIER deBond state code
            var payload = JSON.stringify(data);

            var eBondRest = new eBondRestPayload().load(this.company, 'u_ebond_relationship', current.sys_id, '', this.url, payload, 'json', this.restMsg, this.httpMethod);
        } else {
            var data = {};
            data.number = current.u_correlation_number.toString();
            data.state = '-1'; // SUPPLIER re-eBond state code
            var payload = JSON.stringify(data);

            var eBondRest = new eBondRestPayload().load(this.company, 'u_ebond_relationship', current.sys_id, '', this.url, payload, 'json', this.restMsg, this.httpMethod);
        }

        this.eLog.write('Debug', 'Exiting.');
        return;
    },

    type: 'eBondIncident_SUPPLIER'
};]]&gt;&lt;/script&gt;&lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;&lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2021-09-21 21:23:19&lt;/sys_created_on&gt;&lt;sys_id&gt;6d961fe8db7630107cb384d86896190d&lt;/sys_id&gt;&lt;sys_mod_count&gt;0&lt;/sys_mod_count&gt;&lt;sys_name&gt;eBondIncident_SUPPLIER&lt;/sys_name&gt;&lt;sys_package display_value="Global" source="global"&gt;global&lt;/sys_package&gt;&lt;sys_policy/&gt;&lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;&lt;sys_update_name&gt;sys_script_include_6d961fe8db7630107cb384d86896190d&lt;/sys_update_name&gt;&lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2021-09-21 21:23:19&lt;/sys_updated_on&gt;&lt;/sys_script_include&gt;&lt;/record_update&gt;</payload>
<payload_hash>794326593</payload_hash>
<remote_update_set display_value="eBond - Templates">e94a1bacdb7630107cb384d868961965</remote_update_set>
<replace_on_upgrade>false</replace_on_upgrade>
<sys_created_by>admin</sys_created_by>
<sys_created_on>2021-09-21 21:35:12</sys_created_on>
<sys_id>614a1bacdb7630107cb384d868961967</sys_id>
<sys_mod_count>0</sys_mod_count>
<sys_recorded_at>17c0a3dddea0000001</sys_recorded_at>
<sys_updated_by>admin</sys_updated_by>
<sys_updated_on>2021-09-21 21:35:12</sys_updated_on>
<table/>
<target_name>eBondIncident_SUPPLIER</target_name>
<type>Script Include</type>
<update_domain>global</update_domain>
<update_guid>1b87972c6c763010d47d2f77a4dc14de</update_guid>
<update_guid_history>1b87972c6c763010d47d2f77a4dc14de:794326593</update_guid_history>
<update_set display_value=""/>
<view/>
</sys_update_xml>
<sys_update_xml action="INSERT_OR_UPDATE">
<action>INSERT_OR_UPDATE</action>
<application display_value="Global">global</application>
<category>customer</category>
<comments/>
<name>sysevent_register_9845d7e8db7630107cb384d868961919</name>
<payload><![CDATA[<?xml version="1.0" encoding="UTF-8"?><record_update table="sysevent_register"><sysevent_register action="INSERT_OR_UPDATE"><caller_access/><description/><event_name>ebond.incident.outbound.{SUPPLIER}</event_name><fired_by/><queue/><suffix/><sys_class_name>sysevent_register</sys_class_name><sys_created_by>admin</sys_created_by><sys_created_on>2021-09-21 21:13:52</sys_created_on><sys_id>9845d7e8db7630107cb384d868961919</sys_id><sys_mod_count>1</sys_mod_count><sys_name>ebond.incident.outbound.{SUPPLIER}</sys_name><sys_package display_value="Global" source="global">global</sys_package><sys_policy/><sys_scope display_value="Global">global</sys_scope><sys_update_name>sysevent_register_9845d7e8db7630107cb384d868961919</sys_update_name><sys_updated_by>admin</sys_updated_by><sys_updated_on>2021-09-21 21:15:12</sys_updated_on><table/></sysevent_register></record_update>]]></payload>
<payload_hash>1401363248</payload_hash>
<remote_update_set display_value="eBond - Templates">e94a1bacdb7630107cb384d868961965</remote_update_set>
<replace_on_upgrade>false</replace_on_upgrade>
<sys_created_by>admin</sys_created_by>
<sys_created_on>2021-09-21 21:35:12</sys_created_on>
<sys_id>654a1bacdb7630107cb384d868961966</sys_id>
<sys_mod_count>0</sys_mod_count>
<sys_recorded_at>17c0a37dd0e0000001</sys_recorded_at>
<sys_updated_by>admin</sys_updated_by>
<sys_updated_on>2021-09-21 21:35:12</sys_updated_on>
<table/>
<target_name>ebond.incident.outbound.{SUPPLIER}</target_name>
<type>Event Registration</type>
<update_domain>global</update_domain>
<update_guid>93061be85b763010d6b3f6ee1bd2dccd</update_guid>
<update_guid_history>93061be85b763010d6b3f6ee1bd2dccd:1401363248,e4b59be88b763010eb90a7c5086f176f:1401363248,05651fa8eb763010f3759381e083be97:313462832</update_guid_history>
<update_set display_value=""/>
<view/>
</sys_update_xml>
<sys_update_xml action="INSERT_OR_UPDATE">
<action>INSERT_OR_UPDATE</action>
<application display_value="Global">global</application>
<category>customer</category>
<comments/>
<name>sysevent_register_7c69576cdb7630107cb384d8689619bc</name>
<payload><![CDATA[<?xml version="1.0" encoding="UTF-8"?><record_update table="sysevent_register"><sysevent_register action="INSERT_OR_UPDATE"><caller_access/><description/><event_name>ebond.relationship.management.{SUPPLIER}</event_name><fired_by/><queue/><suffix/><sys_class_name>sysevent_register</sys_class_name><sys_created_by>admin</sys_created_by><sys_created_on>2021-09-21 21:31:25</sys_created_on><sys_id>7c69576cdb7630107cb384d8689619bc</sys_id><sys_mod_count>1</sys_mod_count><sys_name>ebond.relationship.management.{SUPPLIER}</sys_name><sys_package display_value="Global" source="global">global</sys_package><sys_policy/><sys_scope display_value="Global">global</sys_scope><sys_update_name>sysevent_register_7c69576cdb7630107cb384d8689619bc</sys_update_name><sys_updated_by>admin</sys_updated_by><sys_updated_on>2021-09-21 21:31:47</sys_updated_on><table/></sysevent_register></record_update>]]></payload>
<payload_hash>885677136</payload_hash>
<remote_update_set display_value="eBond - Templates">e94a1bacdb7630107cb384d868961965</remote_update_set>
<replace_on_upgrade>false</replace_on_upgrade>
<sys_created_by>admin</sys_created_by>
<sys_created_on>2021-09-21 21:35:12</sys_created_on>
<sys_id>ad4a1bacdb7630107cb384d868961965</sys_id>
<sys_mod_count>0</sys_mod_count>
<sys_recorded_at>17c0a45aedc0000001</sys_recorded_at>
<sys_updated_by>admin</sys_updated_by>
<sys_updated_on>2021-09-21 21:35:12</sys_updated_on>
<table/>
<target_name>ebond.relationship.management.{SUPPLIER}</target_name>
<type>Event Registration</type>
<update_domain>global</update_domain>
<update_guid>5489532c257630104b3b6d7646560319</update_guid>
<update_guid_history>5489532c257630104b3b6d7646560319:885677136,a379532c167630104d2e18b235522027:885677136,c269972cbc763010bed00bf67bbe22c7:680501520</update_guid_history>
<update_set display_value=""/>
<view/>
</sys_update_xml>
<sys_update_xml action="INSERT_OR_UPDATE">
<action>INSERT_OR_UPDATE</action>
<application display_value="Global">global</application>
<category>customer</category>
<comments/>
<name>sys_script_2fe7dfe8db7630107cb384d8689619de</name>
<payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update sys_domain="global" table="sys_script"&gt;&lt;sys_script action="INSERT_OR_UPDATE"&gt;&lt;abort_action&gt;false&lt;/abort_action&gt;&lt;access&gt;package_private&lt;/access&gt;&lt;action_delete&gt;false&lt;/action_delete&gt;&lt;action_insert&gt;true&lt;/action_insert&gt;&lt;action_query&gt;false&lt;/action_query&gt;&lt;action_update&gt;false&lt;/action_update&gt;&lt;active&gt;true&lt;/active&gt;&lt;add_message&gt;false&lt;/add_message&gt;&lt;advanced&gt;true&lt;/advanced&gt;&lt;change_fields&gt;false&lt;/change_fields&gt;&lt;client_callable&gt;false&lt;/client_callable&gt;&lt;collection&gt;ecc_queue&lt;/collection&gt;&lt;condition&gt;new eBondIncident_SUPPLIER().checkCondition();&lt;/condition&gt;&lt;description/&gt;&lt;execute_function&gt;false&lt;/execute_function&gt;&lt;filter_condition/&gt;&lt;is_rest&gt;false&lt;/is_rest&gt;&lt;message/&gt;&lt;name&gt;eBond_SUPPLIER_Response&lt;/name&gt;&lt;order&gt;100&lt;/order&gt;&lt;priority&gt;100&lt;/priority&gt;&lt;rest_method/&gt;&lt;rest_method_text/&gt;&lt;rest_service/&gt;&lt;rest_service_text/&gt;&lt;rest_variables/&gt;&lt;role_conditions/&gt;&lt;script&gt;&lt;![CDATA[(function executeRule(current, previous /*null when async*/ ) {

    var supplier = 'SUPPLIER';

    eLog = new eBondLog();
    eLog.u_direction = 'inbound';
    eLog.u_location = 'Business Rules';
    eLog.u_name = 'eBond_' + supplier + '_Response';
    eLog.u_source = 'executeRule';
    eLog.u_supplier = supplier;
    eLog.u_correlate_id = current.sys_id;
    eLog.u_correlate_class_name = current.sys_class_name;
    eLog.write('Debug', 'Entering.');

    new eBondIncident_SUPPLIER().processResponse();

    // security check to make sure the sender is a known source
    var url = new GlideRecord('u_ebond_registry');
    url.addQuery('u_supplier', supplier);
    url.addQuery('u_key', 'outbound.url.endpoint');
    url.query();
    if (url.next()) {
        if (current.source != url.u_value) {
            eLog.write('High', 'Security Alert. Inbound source REST message for ' + supplier + ' mismatch.\nExpected: ' + url.u_value + '\nReceived: ' + current.source);
            return;
        }
    } else {
        eLog.write('High', supplier + ' is missing eBond registry key outbound.url.endpoint.');
        return;
    }

    eLog.write('Debug', 'ECC Queue sys_id: ' + current.sys_id);
    eLog.write('Debug', 'ECC Queue topic: ' + current.topic);
    eLog.write('Debug', 'ECC Queue state: ' + current.state);
    eLog.write('Debug', 'ECC Queue payload: ' + current.payload);
    eLog.write('Debug', 'ECC Queue response to: ' + current.response_to);

    // evaluate the response	
    var eccREST = new RESTECCResponse(current);
    var responseBody = eccREST.getBody();
    var responseObj = JSON.parse(responseBody);

    // pull the REST pool record from the agent correlator
    var restPayloadRec = new GlideRecord('u_ebond_rest_payload');
    restPayloadRec.get(current.response_to.agent_correlator);
    restPayloadRec.u_http_response = eccREST.getBody();
    var httpStatusCode = eccREST.getStatusCode();
    restPayloadRec.u_http_status_code = parseInt(httpStatusCode);
    restPayloadRec.u_status = 'processed';
    restPayloadRec.update();

    // source: https://www.iana.org/assignments/http-status-codes/http-status-codes.xhtml
    // 1xx: Informational - Request received, continuing process
    // 2xx: Success - The action was successfully received, understood, and accepted
    // 3xx: Redirection - Further action must be taken in order to complete the request
    // 4xx: Client Error - The request contains bad syntax or cannot be fulfilled
    // 5xx: Server Error - The server failed to fulfill an apparently valid request

    // pull the relationship record from the REST pool record
    var relationship = new GlideRecord('u_ebond_relationship');
    relationship.get(restPayloadRec.u_source);
    eLog.write('Debug', 'Relationship: ' + relationship.sys_id);
    var executeNext = false;
    if (httpStatusCode.substring(0, 1) == '2') {
        relationship.u_out = 'up';
        executeNext = true;
    } else {
        relationship.u_out = 'down';
    }
    relationship.u_correlation_number = responseObj.number;
    relationship.u_correlation_id = responseObj.sys_id;
    relationship.update();

    // process the next REST message for the ticket
    if (executeNext) {
        var next = new eBondRestPayload().executeNext(relationship.sys_id);
    }

    // pull the company record for the supplier
    var company = new GlideRecord('core_company');
    company.addQuery('stock_symbol', supplier);
    company.query();
    company.next();

    // pull the incident record from the relationship record
    var incident = new GlideRecord('incident');
    incident.get(relationship.u_source);

    // update the incident u_ebonded_with
    // traverse all related eBonds
    var relationshipChk = new GlideRecord('u_ebond_relationship');
    relationshipChk.addQuery('u_source', relationship.u_source);
    relationshipChk.addQuery('u_status', 'ebonded');
    relationshipChk.addQuery('u_company', company.sys_id);
    relationshipChk.query();

    var arrUtil = new ArrayUtil();
    var arr = incident.u_ebonded_with.toString().split(',');
    var pos = arrUtil.indexOf(arr, company.getValue('sys_id'));
    if (relationshipChk.getRowCount() &gt; 0) {
        if (pos &lt; 0) {
            arr.push(company.getValue('sys_id'));
            incident.u_ebonded_with = arr.toString();
        }
    } else {
        if (pos &gt;= 0) {
            arr.splice(pos, 1);
            incident.u_ebonded_with = arr.toString();
        }
    }
    incident.setWorkflow(false);
    incident.update();

    // update the ecc queue record
    current.state = 'processed';
    var gdt = new GlideDateTime();
    current.processed = gdt;
    current.setWorkflow(false);
    current.update();

    eLog.write('Debug', 'Exiting.');
})(current, previous);]]&gt;&lt;/script&gt;&lt;sys_class_name&gt;sys_script&lt;/sys_class_name&gt;&lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2021-09-21 21:28:14&lt;/sys_created_on&gt;&lt;sys_domain&gt;global&lt;/sys_domain&gt;&lt;sys_domain_path&gt;/&lt;/sys_domain_path&gt;&lt;sys_id&gt;2fe7dfe8db7630107cb384d8689619de&lt;/sys_id&gt;&lt;sys_mod_count&gt;0&lt;/sys_mod_count&gt;&lt;sys_name&gt;eBond_SUPPLIER_Response&lt;/sys_name&gt;&lt;sys_overrides/&gt;&lt;sys_package display_value="Global" source="global"&gt;global&lt;/sys_package&gt;&lt;sys_policy/&gt;&lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;&lt;sys_update_name&gt;sys_script_2fe7dfe8db7630107cb384d8689619de&lt;/sys_update_name&gt;&lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2021-09-21 21:28:14&lt;/sys_updated_on&gt;&lt;template/&gt;&lt;when&gt;after&lt;/when&gt;&lt;/sys_script&gt;&lt;sys_translated_text action="delete_multiple" query="documentkey=2fe7dfe8db7630107cb384d8689619de"/&gt;&lt;/record_update&gt;</payload>
<payload_hash>-2073790671</payload_hash>
<remote_update_set display_value="eBond - Templates">e94a1bacdb7630107cb384d868961965</remote_update_set>
<replace_on_upgrade>false</replace_on_upgrade>
<sys_created_by>admin</sys_created_by>
<sys_created_on>2021-09-21 21:35:12</sys_created_on>
<sys_id>ad4a1bacdb7630107cb384d868961966</sys_id>
<sys_mod_count>0</sys_mod_count>
<sys_recorded_at>17c0a425ecb0000001</sys_recorded_at>
<sys_updated_by>admin</sys_updated_by>
<sys_updated_on>2021-09-21 21:35:12</sys_updated_on>
<table>ecc_queue</table>
<target_name>eBond_SUPPLIER_Response</target_name>
<type>Business Rule</type>
<update_domain>global</update_domain>
<update_guid>13a85f6cda7630101c41d67a5aa64bf0</update_guid>
<update_guid_history>13a85f6cda7630101c41d67a5aa64bf0:-2073790671</update_guid_history>
<update_set display_value=""/>
<view/>
</sys_update_xml>
<sys_update_xml action="INSERT_OR_UPDATE">
<action>INSERT_OR_UPDATE</action>
<application display_value="Global">global</application>
<category>customer</category>
<comments/>
<name>sysevent_script_action_fa16532cdb7630107cb384d868961959</name>
<payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update sys_domain="global" table="sysevent_script_action"&gt;&lt;sysevent_script_action action="INSERT_OR_UPDATE"&gt;&lt;active&gt;false&lt;/active&gt;&lt;condition_script/&gt;&lt;description/&gt;&lt;event_name&gt;ebond.incident.outbound.{SUPPLIER}&lt;/event_name&gt;&lt;name&gt;eBond Incident Outbound {SUPPLIER}&lt;/name&gt;&lt;order&gt;100&lt;/order&gt;&lt;script&gt;&lt;![CDATA[// build out the data payload for {SUPPLIER} 
// store it in u_ebond_rest_payloads to be sent to the {SUPPLIER}
var operation = event.parm1;
var dataBundle = event.parm2;
var returnStatus = new eBondIncident_SUPPLIER().preparePayload(operation, dataBundle);]]&gt;&lt;/script&gt;&lt;synchronous&gt;false&lt;/synchronous&gt;&lt;sys_class_name&gt;sysevent_script_action&lt;/sys_class_name&gt;&lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2021-09-21 21:18:33&lt;/sys_created_on&gt;&lt;sys_domain&gt;global&lt;/sys_domain&gt;&lt;sys_domain_path&gt;/&lt;/sys_domain_path&gt;&lt;sys_id&gt;fa16532cdb7630107cb384d868961959&lt;/sys_id&gt;&lt;sys_mod_count&gt;0&lt;/sys_mod_count&gt;&lt;sys_name&gt;eBond Incident Outbound {SUPPLIER}&lt;/sys_name&gt;&lt;sys_overrides/&gt;&lt;sys_package display_value="Global" source="global"&gt;global&lt;/sys_package&gt;&lt;sys_policy/&gt;&lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;&lt;sys_update_name&gt;sysevent_script_action_fa16532cdb7630107cb384d868961959&lt;/sys_update_name&gt;&lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2021-09-21 21:18:33&lt;/sys_updated_on&gt;&lt;/sysevent_script_action&gt;&lt;/record_update&gt;</payload>
<payload_hash>1801457055</payload_hash>
<remote_update_set display_value="eBond - Templates">e94a1bacdb7630107cb384d868961965</remote_update_set>
<replace_on_upgrade>false</replace_on_upgrade>
<sys_created_by>admin</sys_created_by>
<sys_created_on>2021-09-21 21:35:12</sys_created_on>
<sys_id>e94a1bacdb7630107cb384d868961966</sys_id>
<sys_mod_count>0</sys_mod_count>
<sys_recorded_at>17c0a39826c0000001</sys_recorded_at>
<sys_updated_by>admin</sys_updated_by>
<sys_updated_on>2021-09-21 21:35:12</sys_updated_on>
<table>ebond.incident.outbound.{SUPPLIER}</table>
<target_name>eBond Incident Outbound {SUPPLIER}</target_name>
<type>Script Action</type>
<update_domain>global</update_domain>
<update_guid>2576132cf7763010e785051a9bd5ae04</update_guid>
<update_guid_history>2576132cf7763010e785051a9bd5ae04:1801457055</update_guid_history>
<update_set display_value=""/>
<view/>
</sys_update_xml>
</unload>
